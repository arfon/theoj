<script>

    window.Oj.paperHelpers = {

        ASSIGNMENT_ORDER: [ 'submittor', 'collaborator', 'editor', 'reviewer' ],

        actionForPaper: function(paper){
            if (!paper) return;

            var has_role = function(role) { return paper.user_permissions.indexOf(role) >= 0; };

            if ( paper.pending_issues_count>1 && this.hasRole(paper, 'submittor') )
                return 'needs-attention';

            else if (paper.state=='under_review')
                return 'needs-attention';

            else if (paper.state=='rejected')
                return 'needs-attention';

            else if (paper.state=='accepted')
                return 'accepted';

            else if (paper.state=='rejected')
                return 'rejected';

            else if (this.hasRole(paper, 'submittor'))
                return 'in-process';

        },

        hasRole(paper, role) {
            return paper.user_permissions.indexOf(role) >= 0;
        },

        isOwnAnnotation: function(annotation, paper) {
            if (!annotation || !paper)
              return false;

            return paper.current_assignment.sha == annotation.assignment;
        },

        // Given a assignment sha returns the assignment object from the paper
        // With some additional metadata
        assignmentFromSha: function(paper, assignment_sha) {
            if (!assignment_sha)
                return undefined;

            if (!paper.assignmentsBySha)
                paper.assignmentsBySha = {};

            if (paper.assignmentsBySha[assignment_sha]===undefined) {
                var index = Oj.utils.indexOf(paper.assigned_users, function(a) {return a.sha == assignment_sha} );

                if (index >= 0) {
                    var assignment = paper.assigned_users[index];
                    assignment.index = index;

                } else {
                    var assignment = null;
                }

                paper.assignmentsBySha[assignment_sha] = assignment;
            }

            return paper.assignmentsBySha[assignment_sha];
        },

        sortAssignments: function(assignments) {
            if (!assignments)
              return assignments;

            return assignments.slice(0).sort( function(a,b) {
                        var ai = window.Oj.paperHelpers .ASSIGNMENT_ORDER.indexOf(a.role),
                            bi = window.Oj.paperHelpers .ASSIGNMENT_ORDER.indexOf(b.role);
                        if (ai != bi)
                            return ai-bi;
                        var an = (a.user && a.user.name) || '',
                            bn = (b.user && b.user.name) || '';
                        if (an > bn)
                            return 1;
                        else
                            return -1;
                  });
        },

        providerPart: function(typed_provider_id) {
            return typed_provider_id.split(':').pop();
        }

    };

</script>
