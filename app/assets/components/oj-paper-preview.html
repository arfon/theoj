<polymer-element name='oj-paper-preview' attributes='user paper_id router'>
  <template>

    <template if={{paper_details}}>
      <div layout horizontal flex>
        <template if={{hidePDF}}>
          <div flex id='preview'>
            <iframe id='pfd_preview' style="height:800px" src="{{paper_details | preview_url}}"  frameborder="0"></iframe>
          </div>
        </template>

        <div id="details">

          <h2>Preview of {{paper_details.title}} </h2>

          <ul id='authors'>
            <template repeat="{{author in paper_details.authors}}">
              <li>{{author.name}}</li>
            </template>
          </ul>

          <p id='summary'>{{paper_details.summary}}</p>
          <paper-button raised role='button'  on-tap={{submitForReview}}>Submit for review</paper-button>

        </div>
      </div>
    </template>

    <template if={{$.detailsRequest.loading}}>
      <paper-spinner active></paper-spinner>
    </template>

    <core-ajax id=postRequest
               url='/papers/'
               method=POST
               contentType="application/json"
               handleAs=json
               on-core-response={{response}} >
    </core-ajax>

    <core-ajax id=detailsRequest
               auto
               url="{{paper_id | arxiv_lookup_url}}"
               handleAs=json
               response={{paper_details}}
               on-core-error={{onError}}
            ></core-ajax>
    <core-media-query query="min-width: 930px" queryMatches="{{hidePDF}}"></core-media-query>

    <style>
      #preview{
        width: 50%;
        min-height: 600px
      }
      #preview iframe{
        width:100%;
        height: 100%;
      }
      #details{
        width: 50%;
        box-sizing: border-box;
        padding: 0 20px
      }
      paper-button{
        background: #3e50b4;
        color: white;
      }
      #authors{
        list-style: none;
      }
      #authors li{
        display: inline;
      }

    </style>

  </template>

  <script>
    Polymer({
      onError: function(event) {
          var xhr = event.detail.xhr;

          if (xhr.status == 404)
            var message = 'The paper could not be found. Please try again.';
          else
            var message = 'There was an error retrieving the paper: ' + xhr.statusText + ' (' + xhr.status + ')';

          this.fire("notification", message);
          this.router.go("/submit");
      },
      preview_url:function(paper){
        var link = paper.links.filter(function(link){return link.content_type=="application/pdf"})[0].url
        if(link.indexOf(".pdf")==-1){
          link+=".pdf"
        }
        return "http://docs.google.com/gview?url="+link+"&embedded=true"
      },
      arxiv_lookup_url:function(paper_id){
        return "/papers/"+paper_id+"/arXiv_details"
      },
      params:function(){
        return JSON.stringify({paper:{location: this.paper_details.links[1].url, arxiv_id : this.paper_id}})
      },
      submitForReview:function(event){
        this.$.postRequest.body = this.params();
        this.$.postRequest.go()
      },
      response:function(response){
        this.fire("notification", "Paper "+this.paper_details.title+" submitted");
        this.router.go("/papers")
      }
    })
  </script>
</polymer-element>
