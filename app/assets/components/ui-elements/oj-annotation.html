<dom-module id="oj-annotation">

  <template>

    <!-- Collapsed Display -->

    <div class$="{{containerClass('collapsed', annotation, annotation.state)}}">
        <oj-reviewer-annotation-controls paper="{{paper}}" annotation="{{annotation}}"></oj-reviewer-annotation-controls>

        <div class="container-inner">

          <div on-tap="expand" class="header">
              <div class="text">{{headerDisplay(annotation.body, annotation.assignment, paper)}}</div>
              <div class="date">{{latestDateDisplay(annotation, annotation.responses)}}</div>
              <div class="count">{{replyCountDisplay(annotation.responses)}}</div>
          </div>

        </div>
    </div>

    <!-- Overlay this to get animated expansion to work nicely -->

    <iron-collapse id="collapsible" opened="{{annotation.open}}" on-iron-resize="annotationAfterOpen">
      <iron-a11y-keys keys="esc" on-keys-pressed="collapse"></iron-a11y-keys>

        <!-- Expanded Display -->

      <div class$="{{containerClass('expanded', annotation, annotation.state)}}">
          <div class="container-inner">

              <template is="dom-if" if="{{!annotation.new}}">
                  <oj-reviewer-annotation-controls paper="{{paper}}" annotation="{{annotation}}"></oj-reviewer-annotation-controls>

                  <div on-tap="collapse" class="header">
                      <div class="text">{{author}}</div>
                      <div class="date">{{dateDisplay(annotation)}}</div>
                  </div>

                  <markdown-content class="issue" markdown="{{annotation.body}}"></markdown-content>

                  <oj-annotation-comments id="comments" paper="{{paper}}" annotation="{{annotation}}"
                                              on-new-response-shown="newResponseShown"></oj-annotation-comments>
              </template>

              <template is="dom-if" if="{{annotation.new}}">

                  <iron-a11y-keys keys="esc" on-keys-pressed="close"></iron-a11y-keys>
                  <iron-a11y-keys keys="shift+enter" on-keys-pressed="submitAnnotation"></iron-a11y-keys>
                  <markdown-text-area id="annotationTextArea" class="issue" value="{{text}}"></markdown-text-area>

                  <div class="layout horizontal">
                      <span class="layout flex"></span>
                      <paper-button on-click="submitAnnotation" disabled$="{{disableSaving(text, saving)}}">Add</paper-button>
                      <paper-button on-click="close" disabled$="{{saving}}">Cancel</paper-button>
                  </div>

              </template>

          </div>
      </div>

    </iron-collapse>

    <api-request id="saveAnnotationRequest"
                 method="post"
                 loading="{{saving}}"
                 api="{{paperAnnotationsApi(paper)}}"
                 on-success="annotationSaved"
                 on-error="annotationError"></api-request>

      <style>
          :host{
          }

          .container {
              box-sizing: border-box;
              padding:    0 18px;
              @apply      --disable-selection;
          }
          .container-inner {
              box-sizing:       border-box;
              background-color: #efefef;
              color:            #7d7d7d;
              font-weight:      400;
              padding:          2px;
          }
          .expanded .container-inner {
              background-color: #f7f7f7;
          }

          iron-collapse {
              position: absolute;
              top:      0;
              left:     0;
              right:    0;
              z-index:  1;
          }

          .header {
              @apply(--layout-horizontal);
              @apply(--layout-end);
          }

          .header .text {
              font-family: Neuton;
              color:         #192023;
              font-size:     20px;/* Approximation due to font substitution */
              font-weight:   700;
              line-height:   30px;
              @apply(--ellipses);
          }
          .header .date {
              font-family: Roboto;
              color:         #b3b3b3;
              font-size:     14px;/* Approximation due to font substitution */
              font-style:    italic;
              margin-bottom: 4px;
              margin-left:   6px;
              white-space:   nowrap;
          }
          .header .count {
              font-size:     0.7em;
              flex-grow:     2;
              text-align:    right;
              margin-left:   6px;
              margin-right:  30px; /* Leave space for the controls */
              margin-bottom: 4px;
              white-space:   nowrap;
          }

          .issue {
              font-family: Roboto;
              color:       black;
              font-size:   14px;/* Approximation due to font substitution */
              font-weight: 400;

              cursor:     pointer;
              padding:     0 4px 4px 4px;
              min-height:  25px;
          }

          .collapsed .header {
              overflow: hidden;
          }

          .collapsed .issue {
              height: 25px;
          }
          .collapsed .issue::shadow #renderedContent {
              @apply --ellipses;
          }

          :host .container /deep/ paper-button {
              padding-top:    0;
              padding-bottom: 0;
              margin:         4px 0 0 4px;
              color:          rgb(120, 120, 120);
              border:         1px solid rgb(120, 120, 120);
              box-shadow:     0 4px 0 0 rgba(218, 218, 218, 0.3);
              height:         28px;
              line-height:    11px;
          }
          :host .container /deep/ paper-button iron-icon {
              width:         16px;
              height:        16px;
              padding:       0;
              margin:        -8px 4px 8px;
          }
          :host .container /deep/ paper-button:not([disabled]):hover, paper-button:not([disabled]):active {
              color:        rgb( 90,  90,  90);
              border-color: rgb( 90,  90,  90);
          }
          :host .container /deep/ paper-button[disabled] {
              border-color:  rgb(200,200,200);
              color:         rgb(200,200,200);
          }

          oj-reviewer-annotation-controls {
              position: absolute;
              top:      7px;
              right:    20px;
          }

          markdown-text-area {
              width: 100%;
          }
          markdown-text-area::shadow a.toggle {
              bottom:         -45px;
              right:          154px;
              font-size:      12px;
              color:          #888;
              text-transform: capitalize;
          }
          markdown-text-area::shadow markdown-content::shadow #renderedContent {
              padding: 4px;
          }

      </style>

  </template>

  <script>
    //Note that the semantics for observing properties and arrays has changed.
    Polymer({
      is: 'oj-annotation',

      properties: {
        annotation: {
          notify:     true
        },
        paper: {
            notify: true
        },
        author: {
            computed: 'authorFor(paper, annotation.assignment)'
        },
        firstLine: {
            computed: 'getFirstLine(annotation.body)'
        },
        text: {
            notify: true
        },
        saving: {
            notify: true
        }
      },

      observers: [
        'annotationOpenChanged(annotation.open)'
      ],

      ready: function() {
        if (this.annotation && this.annotation.new) {
          var component = this;
          this.async(function () {
              var edit = component.$$('#annotationTextArea');
              edit.focus();
              edit.select();
          }, 50);
        }
      },

      /**** API *****/

      close: function() {
          this.collapse();
      },

      showNewResponse: function() {
          this.$.comments.showNewComment();
      },

      scrollAnnotationIntoView: function(prioritize_top) {
        if (!this.annotation.open)
          return;

        console.log('scrollIntoView', prioritize_top);

        var list = this.offsetParent;
        if (list.tagName != 'OJ-ANNOTATION-LIST')
          console.error('annotation parent is not the oj-annotation-list');
        var container = list.offsetParent;
        if (container.id != 'scroller')
          console.error('annotation-list parent is not the #scroller');

        var spacing = 10; /*px*/
        var top = this.offsetTop;
        var height = this.$.collapsible.offsetHeight;
        top = top + list.offsetTop;

        console.log('tops', this.offsetTop, list.offsetTop, top, container.scrollTop, container.offsetTop);
        console.log('heights', height, container.offsetHeight);

        var newTop;
        if (prioritize_top && top < container.scrollTop) {
          newTop = top - spacing;

        } else if (top + height > container.scrollTop + container.offsetHeight) {
          newTop = top + height + spacing - container.offsetHeight;
          if (prioritize_top && top < newTop)
            newTop = top;

        } else if (!prioritize_top && top < container.scrollTop) {
          newTop = top - spacing;

        }

        if (newTop !== undefined)
          $(container).animate({ scrollTop: newTop }, 500);
      },

      /***********************/

      headerDisplay: function(assignment) {
          return this.author || this.firstLine;
      },

      latestDateDisplay: function() {
        if (!this.annotation)
            return null;
        var date = this.latestDateForAnnotation(this.annotation);
        return this.shortDateString(date);
      },

      dateDisplay: function() {
          if (!this.annotation)
              return null;
          var date = this.annotation.created_at;
          return this.shortDateString(date);
      },

      replyCountDisplay: function() {
        var r = this.annotation.responses;
        var c = r ? r.length : 0;
        return c.toString() + (c==1 ? ' reply' : ' replies');
      },

      annotationOpenChanged: function() {
        if (this.annotation.open)
          this.expand();
        else
          this.collapse();
      },

      annotationAfterOpen: function(event, detail) {
        this.scrollAnnotationIntoView(true);
      },

      newResponseShown: function(event) {
        this.scrollAnnotationIntoView(false);
      },

      collapse: function() {
        this.set('annotation.open', false);
        this.fire('annotation-closed', this);
      },

      expand: function() {
        this.set('annotation.open', true);
        this.fire('annotation-opened', this);
      },

      submitAnnotation: function() {
        if (this.$.saveAnnotationRequest.loading)
          return;
        if (!this.text)
          return;
        this.set('$.saveAnnotationRequest.data', this.annotationData());
        this.$.saveAnnotationRequest.go();
      },

      annotationSaved: function(event, response) {
        this.annotation = response;
        this.fire('annotation-added', this.annotation);
        this.fire('notification', 'Annotation saved.');
        this.text = '';
        this.close();
      },

      annotationError: function(response) {
        this.fire('notification', 'Could not save annotation.');
      },

      annotationData: function() {
        return {
          annotation: {
            body: this.text,
            page: this.annotation.page,
            xStart: this.annotation.xStart,
            yStart: this.annotation.yStart
          }
        };
      },

      getAssignment: function(paper, assignment) {
        return Oj.paperHelpers.assignmentFromSha(paper, assignment);
      },

      containerClass: function(mode, annotation, state) {
        return 'container state-' + annotation.state + ' ' + mode;
      },

        disableSaving: function(text, saving) {
        return !text || saving;
      },

      behaviors: [
        Oj.api,
        Oj.paperHelpers,
        Oj.utils,
        Oj.globalExpressions
      ]

    });
  </script>
</dom-module>
