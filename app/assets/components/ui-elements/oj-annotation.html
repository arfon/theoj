<dom-module id="oj-annotation">

  <template>

      <div id='container' class$="{{containerClass(annotation.open, transitioning)}}">

          <div class="container-inner" on-tap="toggle" >

              <!-- Header, only for existing annotations -->
              <template is="dom-if" if="{{!annotation.new}}">
                  <div class="header">

                    <template is="dom-if" if="{{!annotation.open}}">
                      <div class="text">{{headerDisplay(annotation.body, annotation.assignment, paper)}}</div>
                      <div class="date">{{latestDateDisplay(annotation, annotation.responses)}}</div>
                      <div class="filler layout flex"></div>
                      <div class="count">{{replyCountDisplay(annotation.responses)}}</div>
                    </template>

                    <template is="dom-if" if="{{annotation.open}}">
                      <div class="text">{{author}}</div>
                      <div class="date">{{dateDisplay(annotation)}}</div>
                      <div class="filler layout flex"></div>
                    </template>

                    <oj-reviewer-annotation-controls paper="{{paper}}"
                                                     annotation="{{annotation}}"></oj-reviewer-annotation-controls>
                  </div>
              </template>

              <!-- Expanded Display -->

              <iron-collapse id="collapsible" opened="{{annotation.open}}" transitioning="{{transitioning}}" on-iron-resize="annotationAfterOpen">

                  <!-- Existing Annotations -->
                  <template is="dom-if" if="{{!annotation.new}}">
                      <iron-a11y-keys keys="esc" on-keys-pressed="collapse"></iron-a11y-keys>
                      <markdown-content class="issue" markdown="{{annotation.body}}"></markdown-content>
                      <oj-annotation-comments id="comments"
                                               paper="{{paper}}"
                                               annotation="{{annotation}}"
                                               on-new-response-shown="newResponseShown"></oj-annotation-comments>
                  </template>

                  <!-- New Annotations -->
                  <template is="dom-if" if="{{annotation.new}}">

                      <iron-a11y-keys keys="esc" on-keys-pressed="close"></iron-a11y-keys>
                      <iron-a11y-keys keys="shift+enter" on-keys-pressed="submitAnnotation"></iron-a11y-keys>

                      <markdown-text-area id="annotationTextArea"
                                          class="issue"
                                          value="{{text}}"
                                          placeholder="Make a Comment"
                                          preview-button-label="{{previewButtonLabel}}"></markdown-text-area>

                      <div class="actions layout horizontal">
                          <a class="action" href="#" on-click="togglePreview" data-disabled$="{{!text}}">{{previewButtonLabel}}</a>
                          <span class="filler layout flex"></span>
                          <a class="action" href="#" on-click="submitAnnotation" data-disabled$="{{savingDisabled(text, saving)}}">Add</a>
                          <a class="action" href="#" on-click="close" data-disabled$="{{saving}}">Cancel</a>
                      </div>

                  </template>

              </iron-collapse>

          </div>

      </div>

      <api-request id="saveAnnotationRequest"
                   method="post"
                   loading="{{saving}}"
                   api="{{paperAnnotationsApi(paper)}}"
                   on-success="annotationSaved"
                   on-error="annotationError"></api-request>

      <style>
          :host{
              cursor:      default;
          }

          .container {
              box-sizing: border-box;
              padding:    0 18px;
              @apply(--disable-selection);
          }
          .container-inner {
              box-sizing:       border-box;
              background-color: #efefef;
              color:            #7d7d7d;
              font-weight:      400;
              padding:          2px;
          }
          .open .container-inner, .transitioning .container-inner {
              box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
          }


          iron-collapse {
              background-color: #f7f7f7;
          }

          .header {
              @apply(--layout-horizontal);
              @apply(--layout-end);
          }
          .open .header, .transitioning .header {
              background: #f7f7f7;
          }

          .header .text {
              font-family: Neuton;
              color:         #192023;
              font-size:     20px;/* Approximation due to font substitution */
              font-weight:   700;
              line-height:   30px;
              @apply(--ellipses);
          }
          .header .date {
              font-family: Roboto;
              color:         #b3b3b3;
              font-size:     14px;/* Approximation due to font substitution */
              font-style:    italic;
              margin-bottom: 4px;
              margin-left:   6px;
              white-space:   nowrap;
          }
          .header .count {
              font-size:     0.7em;
              text-align:    right;
              margin-left:   6px;
              margin-right:  6px;
              margin-bottom: 4px;
              white-space:   nowrap;
          }
          .header oj-reviewer-annotation-controls {
              margin-bottom: 4px;
          }

          .issue {
              font-family: Roboto;
              color:       black;
              font-size:   14px;/* Approximation due to font substitution */
              font-weight: 400;

              min-height:  25px;
          }

          .actions {
              line-height:     18px;
          }
          .action {
              text-decoration: underline;
              font-size:       12px;
              color:           #888;
              font-variant:    small-caps;
              margin-right:    4px;
              margin-left:     4px;
          }
          .action:first-child {
              margin-left:     4px;
          }
          .action[data-disabled] {
              text-decoration: none;
              color:           #b0b0b0;
              cursor:          default;
          }

          markdown-text-area {
              width: 100%;
          }

      </style>

  </template>

  <script>
    //Note that the semantics for observing properties and arrays has changed.
    Polymer({
      is: 'oj-annotation',

      properties: {
        annotation: {
          notify:     true
        },
        paper: {
            notify: true
        },
        author: {
            computed: 'authorFor(paper, annotation.assignment)'
        },
        firstLine: {
            computed: 'getFirstLine(annotation.body)'
        },
        text: {
            notify: true
        },
        saving: {
            notify: true
        },
        transitioning: {
            type:   Boolean
        },
        previewButtonLabel: {
            notify : true
        }
      },

      observers: [
        'annotationOpenChanged(annotation.open)'
      ],

      ready: function() {
        if (this.annotation && this.annotation.new) {
          var component = this;
                    this.async(function () {
              var edit = component.$$('#annotationTextArea');
              edit.focus();
              edit.select();
          }, 50);
        }
      },

      /**** API *****/

      close: function(event) {
          if (event)
            event.preventDefault();
          if (this.saving)
              return;
          this.collapse();
      },

      showNewResponse: function() {
          this.$$('#comments').showNewComment();
      },

      scrollAnnotationIntoView: function(prioritize_top) {
        if (!this.annotation.open)
          return;

        var list = this.offsetParent;
        if (list.tagName != 'OJ-ANNOTATION-LIST')
          console.error('annotation parent is not the oj-annotation-list');
        var container = list.offsetParent;
        if (container.id != 'scroller')
          console.error('annotation-list parent is not the #scroller');

        var spacing = 10; /*px*/
        var top = this.offsetTop;
        var height = this.offsetHeight;
        top = top + list.offsetTop;

        var newTop;
        if (prioritize_top && top < container.scrollTop) {
          newTop = top - spacing;

        } else if (top + height > container.scrollTop + container.offsetHeight) {
          newTop = top + height + spacing - container.offsetHeight;
          if (prioritize_top && top < newTop)
            newTop = top;

        } else if (!prioritize_top && top < container.scrollTop) {
          newTop = top - spacing;

        }

        if (newTop)
            if (Math.abs(newTop-container.scrollTop) > 5) // Avoid irritating small changes
                $(container).animate({ scrollTop: newTop }, 500);
      },

      /***********************/

      headerDisplay: function(assignment) {
          return this.author || this.firstLine;
      },

      latestDateDisplay: function() {
        if (!this.annotation)
            return null;
        var date = this.latestDateForAnnotation(this.annotation);
        return this.shortDateString(date);
      },

      dateDisplay: function() {
          if (!this.annotation)
              return null;
          var date = this.annotation.created_at;
          return this.shortDateString(date);
      },

      replyCountDisplay: function() {
        var r = this.annotation.responses;
        var c = r ? r.length : 0;
        return c.toString() + (c==1 ? ' reply' : ' replies');
      },

      annotationOpenChanged: function() {
        if (this.annotation.open)
          this.expand();
        else
          this.collapse();
      },

      annotationAfterOpen: function(event, detail) {
        this.scrollAnnotationIntoView(true);
      },

      newResponseShown: function(event) {
        this.scrollAnnotationIntoView(false);
      },

      collapse: function() {
        this.set('annotation.open', false);
        this.fire('annotation-closed', this);
      },

      expand: function() {
        this.set('annotation.open', true);
        this.fire('annotation-opened', this);
      },

      toggle: function() {
          if (this.annotation.new)
              return;

          if (this.annotation.open)
              this.collapse();
          else
              this.expand();
      },

      togglePreview: function(event) {
          event.preventDefault();
          if (!this.text)
              return;

          this.$$('markdown-text-area').togglePreview();
      },

      submitAnnotation: function(event) {
        event.preventDefault();
        if (this.savingDisabled(this.text, this.saving))
            return;

        this.$.saveAnnotationRequest.data = this.annotationData();
        this.$.saveAnnotationRequest.go();
      },

      annotationSaved: function(event, response) {
        $.extend(this.annotation, response);
        this.annotation.new = false;
        this.notifyPath('annotation.new');
        this.notifyPath('annotation.state');
        this.notifyPath('annotation.assignment');
        this.fire('annotation-added', this.annotation);
        this.text = '';
        this.close();
      },

      annotationError: function(response) {
        this.fire('notification', 'Could not save annotation.');
      },

      annotationData: function() {
        return {
          annotation: {
            body: this.text,
            page: this.annotation.page,
            xStart: this.annotation.xStart,
            yStart: this.annotation.yStart
          }
        };
      },

      getAssignment: function(paper, assignment) {
        return Oj.paperHelpers.assignmentFromSha(paper, assignment);
      },

      savingDisabled: function(text, saving) {
        return !text || saving;
      },

      containerClass: function() {
         return 'container' + (this.transitioning    ? ' transitioning' : '') +
                              (this.annotation.open  ? ' open'          : '') +
                              (this.annotation.new   ? ' new'           : '');
      },

      behaviors: [
        Oj.api,
        Oj.paperHelpers,
        Oj.utils,
        Oj.globalExpressions
      ]

    });
  </script>
</dom-module>
